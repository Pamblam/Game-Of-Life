/*! go-life - v2.0.4 */
class GoL{constructor(t,e){e=e||{},this.canvas=t,this.ctx=t.getContext("2d"),this.boxSize=+e.boxSize||10,this.gridColor=e.gridColor||"#BFBFBF",this.aliveColor=e.aliveColor||"#000",this.deadColor=e.deadColor||"#FFF",this.speed=+e.speed||500,this.ruleString=e.ruleString||"B3/S23",this.rule={b:[3],s:[2,3]},this.grid=[],this.running=!1,this.liveCells={},this.gridOverlay=new Image,this.parseRuleString().generateGrid().generateGridOverlay().then(()=>this.drawBoard())}loadPatternFile(t){var e,s;this.running&&this.stop(),this.generateGrid(),e=Math.floor(this.grid.length/2)-Math.floor(t.height/2),s={x:Math.floor(this.grid[0].length/2)-Math.floor(t.width/2)+t.relativePos.x,y:e+t.relativePos.y};for(var i=0;i<t.rows.length;i++)for(var r=0;r<t.rows[i].length;r++)1==t.rows[i][r]&&this.toggleCell(this.grid[s.y+i][s.x+r]);return t.ruleStr&&this.parseRuleString(t.ruleStr),this.drawBoard(),this}parseRuleString(t){t=t||this.ruleString,this.ruleString=t;var e,s=[],i=[];return s=((e="B"===(t=t.toUpperCase().split("/").map(t=>t.trim()))[0][0])?t[0]:t[1]).match(/\d/g)||[],i=(e?t[1]:t[0]).match(/\d/g)||[],this.rule={b:s.map(t=>parseInt(t)),s:i.map(t=>parseInt(t))},this}toggleCell(t){t.alive=!t.alive,t.alive?this.liveCells[t.name]=t:delete this.liveCells[t.name]}generateGridOverlay(){return new Promise(t=>{var e=document.createElement("canvas"),s=e.getContext("2d"),i=new Image;e.width=this.canvas.width,e.height=this.canvas.height,s.lineWidth=1,s.strokeStyle=this.gridColor;for(var r=this.grid[0].length;r--;)s.beginPath(),s.moveTo(this.grid[0][r].x,0),s.lineTo(this.grid[0][r].x,e.height),s.stroke();for(r=this.grid.length;r--;)s.beginPath(),s.moveTo(0,this.grid[r][0].y),s.lineTo(e.width,this.grid[r][0].y),s.stroke();i.onload=(()=>{this.gridOverlay=i,t()}),i.src=e.toDataURL()})}start(){const t=()=>{this.tick().drawBoard(),this.running&&setTimeout(()=>t(),this.speed)};return this.running||(this.running=!0,t()),this}stop(){return this.running=!1,this}generateGrid(){this.grid=[],this.liveCells={};for(let t=0;t<this.canvas.height;t+=this.boxSize){let e=[];for(let s=0;s<this.canvas.width;s+=this.boxSize)e.push(new GoLCell(s,t,this.boxSize,this.grid.length,e.length));this.grid.push(e)}return this}iterateAllCells(t){for(let e=this.grid.length;e--;)for(let s=this.grid[e].length;s--;)if(!1===t(this.grid[e][s]))return this;return this}drawCell(t){return this.ctx.fillStyle=t.alive?this.aliveColor:this.deadColor,this.ctx.fillRect(t.x+.5,t.y+.5,t.size-1,t.size-1),this}drawBoard(){var t=Object.values(this.liveCells);this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.deadColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(var e=t.length;e--;)this.drawCell(t[e]);return this.ctx.drawImage(this.gridOverlay,0,0),this}getNeighbors(t){var e=[];return this.grid[t.row-1]&&(this.grid[t.row-1][t.col-1]&&e.push(this.grid[t.row-1][t.col-1]),this.grid[t.row-1][t.col]&&e.push(this.grid[t.row-1][t.col]),this.grid[t.row-1][t.col+1]&&e.push(this.grid[t.row-1][t.col+1])),this.grid[t.row+1]&&(this.grid[t.row+1][t.col-1]&&e.push(this.grid[t.row+1][t.col-1]),this.grid[t.row+1][t.col]&&e.push(this.grid[t.row+1][t.col]),this.grid[t.row+1][t.col+1]&&e.push(this.grid[t.row+1][t.col+1])),this.grid[t.row][t.col-1]&&e.push(this.grid[t.row][t.col-1]),this.grid[t.row][t.col+1]&&e.push(this.grid[t.row][t.col+1]),e}mutateCell(t){var e=!1,s=this.getNeighbors(t),i=0;for(let t=s.length;t--;)s[t].alive&&i++;return t.alive?~this.rule.s.indexOf(i)||(e=!0):~this.rule.b.indexOf(i)&&(e=!0),e}getRelevantCells(){var t,e=Object.values(this.liveCells),s={};for(let i=e.length;i--;){s[e[i].name]=e[i];for(let r=(t=this.getNeighbors(e[i])).length;r--;)s[t[r].name]=t[r]}return Object.values(s)}tick(){var t=this.getRelevantCells(),e=[];this.rescanCells={};for(let s=t.length;s--;)this.mutateCell(t[s])&&e.push(t[s]);for(let t=e.length;t--;)this.toggleCell(e[t]);return this}}class GoLCell{constructor(t,e,s,i,r,h){this.x=t,this.y=e,this.size=s,this.alive=!1,this.name=`${i},${r}`,this.row=i,this.col=r}}class GoLMouse{constructor(t){this.game=t,this.enabled=!1,this.mouseDown=!1,this.mouseDownOverCellName="",this.mouseHoverOverCellName="",this.createListeners()}enable(){return this.enabled=!0,this}disable(){return this.enabled=!1,this}getCellAt(t,e){var s=Math.floor(t/this.game.boxSize),i=Math.floor(e/this.game.boxSize);return this.game.grid[i][s]}createListeners(){return document.addEventListener("mousedown",t=>{t.target===this.game.canvas&&(0==t.button&&(this.mouseDown=!0),this.handleActiveMouse(t))}),document.addEventListener("mouseup",t=>{0==t.button&&(this.mouseDown=!1),this.mouseDownOverCellName=""}),this.game.canvas.addEventListener("mousemove",t=>{this.handleActiveMouse(t)}),this}handleMouseDown(t){return t.name===this.mouseDownOverCellName?this:(this.mouseDownOverCellName=t.name,this.game.toggleCell(t),this.game.drawBoard(),this)}handleMouseOver(t){if(this.mouseHoverOverCellName!=t.name){this.mouseHoverOverCellName=t.name;var e=new Event("cellhover");e.cell=t,this.game.canvas.dispatchEvent(e)}return this}handleActiveMouse(t){if(!this.enabled)return this;var e=t.clientX-this.game.canvas.offsetLeft,s=t.clientY-this.game.canvas.offsetTop,i=(e=e*this.game.canvas.width/this.game.canvas.clientWidth,s=s*this.game.canvas.height/this.game.canvas.clientHeight,this.getCellAt(e,s));return this.mouseDown?this.handleMouseDown(i):(this.handleMouseOver(i),this)}}class GoLPatternFile{constructor(t){t||(t={}),this.name=t.name||"",this.comments=t.comments||[],this.author=t.author||"",this.relativePos=t.relativePos||{x:0,y:0},this.ruleStr=t.ruleStr||"B3/S23",this.width=t.width||0,this.height=t.height||0,this.rows=t.rows||[]}}class GoLRLE extends GoLPatternFile{constructor(t){super(t)}fromRawData(t){return this.parseName(t).parseComments(t).parseAuthor(t).parsePosition(t).parseRuleFromHeader(t).parseHeaderLine(t).parseCellData(t)}parsePosition(t){var e=(t.match(/^#R.*/gm)||[""])[0];return e?((e=e.match(/-?\d*/g).filter(t=>!!t))[0]&&(this.relativePos.x=parseInt(e[0])),e[1]&&(this.relativePos.y=parseInt(e[1])),this):this}parseRuleFromHeader(t){var e=(t.match(/^#r.*/gm)||[""])[0];return e&&(e=e.substr(2).trim()),this.ruleStr=e,this}parseName(t){var e=(t.match(/^#N.*/gm)||[""])[0];return e&&(e=e.substr(2).trim()),this.name=e,this}parseAuthor(t){var e=(t.match(/^#O.*/gm)||[""])[0];return e&&(e=e.substr(2).trim()),this.author=e,this}parseComments(t){var e=t.match(/^#C.*|^#c.*/gm)||[];return e=e.map(t=>t.substr(2).trim()),this.comments=e,this}parseHeaderLine(t){var e=t.toLowerCase();return(e=((e=e.match(/x\s?=\s?\d*\s?,\s?y\s?=\s?\d*.*/gm))||[""])[0])?(e.split(",").map(t=>t.trim()).forEach(t=>{var e=t.split("=")[1].trim();"x"===t.substr(0,1)?this.width=parseInt(e):"y"===t.substr(0,1)?this.height=parseInt(e):"r"===t.substr(0,1)&&(this.ruleStr=e)}),this):this}parseCellData(t){var e=[],s=[];return((t.match(/^[\dbo\$]*!?$/gm)||[]).filter(t=>!!t).join("").match(/\d*b|\d*o|\d*\$/gm)||[]).forEach(t=>{for(var i=t.substr(-1),r=parseInt((t.match(/\d*/g)||[]).filter(t=>!!t)[0]||1);r--;)"$"==i?(e.push(s),s=[]):s.push("o"==i?1:0)}),s.length&&e.push(s),this.rows=e,this}}