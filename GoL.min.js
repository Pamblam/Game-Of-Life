/*! go-life - v2.0.84 */
class GoL{constructor(e,r){r=r||{},this.renderer=e,this.speed=+r.speed||500,this.ruleString=r.ruleString||"B3/S23",this.rule={b:[3],s:[2,3]},this.grid=[],this.running=!1,this.liveCells={},this.renderer.prepare().then(()=>{this.parseRuleString().generateGrid().render()})}render(){var e=Object.values(this.liveCells);this.renderer.render(e)}loadPatternFile(e){var r,t;this.running&&this.stop(),this.generateGrid(),r=Math.floor(this.grid.length/2)-Math.floor(e.height/2),t={x:Math.floor(this.grid[0].length/2)-Math.floor(e.width/2)+e.relativePos.x,y:r+e.relativePos.y};for(var i=0;i<e.rows.length;i++)for(var s=0;s<e.rows[i].length;s++)1==e.rows[i][s]&&this.toggleCell(this.grid[t.y+i][t.x+s]);return e.ruleStr&&this.parseRuleString(e.ruleStr),this.render(),this}parseRuleString(e){e=e||this.ruleString,this.ruleString=e;var r,t=[],i=[];return t=((r="B"===(e=e.toUpperCase().split("/").map(e=>e.trim()))[0][0])?e[0]:e[1]).match(/\d/g)||[],i=(r?e[1]:e[0]).match(/\d/g)||[],this.rule={b:t.map(e=>parseInt(e)),s:i.map(e=>parseInt(e))},this}toggleCell(e){return e.alive=!e.alive,e.alive?this.liveCells[e.name]=e:delete this.liveCells[e.name],this}start(){const e=()=>{this.tick().render(),this.running&&setTimeout(()=>e(),this.speed)};return this.running||(this.running=!0,e()),this}stop(){return this.running=!1,this}generateGrid(){this.grid=[],this.liveCells={};for(let e=0;e<this.renderer.rows;e++){let e=[];for(let r=0;r<this.renderer.columns;r++)e.push(new GoLCell(this.grid.length,e.length));this.grid.push(e)}return this}iterateAllCells(e){for(let r=this.grid.length;r--;)for(let t=this.grid[r].length;t--;)if(!1===e(this.grid[r][t]))return this;return this}getNeighbors(e){var r=[];return this.grid[e.row-1]&&(this.grid[e.row-1][e.col-1]&&r.push(this.grid[e.row-1][e.col-1]),this.grid[e.row-1][e.col]&&r.push(this.grid[e.row-1][e.col]),this.grid[e.row-1][e.col+1]&&r.push(this.grid[e.row-1][e.col+1])),this.grid[e.row+1]&&(this.grid[e.row+1][e.col-1]&&r.push(this.grid[e.row+1][e.col-1]),this.grid[e.row+1][e.col]&&r.push(this.grid[e.row+1][e.col]),this.grid[e.row+1][e.col+1]&&r.push(this.grid[e.row+1][e.col+1])),this.grid[e.row][e.col-1]&&r.push(this.grid[e.row][e.col-1]),this.grid[e.row][e.col+1]&&r.push(this.grid[e.row][e.col+1]),r}mutateCell(e){var r=!1,t=this.getNeighbors(e),i=0;for(let e=t.length;e--;)t[e].alive&&i++;return e.alive?~this.rule.s.indexOf(i)||(r=!0):~this.rule.b.indexOf(i)&&(r=!0),r}getRelevantCells(){var e,r=Object.values(this.liveCells),t={};for(let i=r.length;i--;){t[r[i].name]=r[i];for(let s=(e=this.getNeighbors(r[i])).length;s--;)t[e[s].name]=e[s]}return Object.values(t)}tick(){var e=this.getRelevantCells(),r=[];this.rescanCells={};for(let t=e.length;t--;)this.mutateCell(e[t])&&r.push(e[t]);for(let e=r.length;e--;)this.toggleCell(r[e]);return this}}class GoLCell{constructor(e,r){this.alive=!1,this.name=`${e},${r}`,this.row=e,this.col=r}}class GoLMouse{constructor(e){this.game=e,this.enabled=!1,this.mouseDown=!1,this.mouseDownOverCellName="",this.mouseHoverOverCellName="",this.createListeners()}enable(){return this.enabled=!0,this}disable(){return this.enabled=!1,this}getCellAt(e,r){var t=Math.floor(e/this.game.renderer.boxSize),i=Math.floor(r/this.game.renderer.boxSize);return this.game.grid[i][t]}createListeners(){return document.addEventListener("mousedown",e=>{e.target===this.game.renderer.ele&&(0==e.button&&(this.mouseDown=!0),this.handleActiveMouse(e))}),document.addEventListener("mouseup",e=>{0==e.button&&(this.mouseDown=!1),this.mouseDownOverCellName=""}),this.game.renderer.ele.addEventListener("mousemove",e=>{this.handleActiveMouse(e)}),this}handleMouseDown(e){return e.name===this.mouseDownOverCellName?this:(this.mouseDownOverCellName=e.name,this.game.toggleCell(e),this.game.renderer.renderCell(e),this)}handleMouseOver(e){if(this.mouseHoverOverCellName!=e.name){this.mouseHoverOverCellName=e.name;var r=new Event("cellhover");r.cell=e,this.game.renderer.ele.dispatchEvent(r)}return this}handleActiveMouse(e){if(!this.enabled)return this;var r=e.clientX-this.game.renderer.ele.offsetLeft,t=e.clientY-this.game.renderer.ele.offsetTop,i=(r=r*this.game.renderer.ele.width/this.game.renderer.ele.clientWidth,t=t*this.game.renderer.ele.height/this.game.renderer.ele.clientHeight,this.getCellAt(r,t));return this.mouseDown?this.handleMouseDown(i):(this.handleMouseOver(i),this)}}class GoLPatternFile{constructor(e){e||(e={}),this.name=e.name||"",this.comments=e.comments||[],this.author=e.author||"",this.relativePos=e.relativePos||{x:0,y:0},this.ruleStr=e.ruleStr||"B3/S23",this.width=e.width||0,this.height=e.height||0,this.rows=e.rows||[]}}class GoLRLE extends GoLPatternFile{constructor(e){super(e)}fromRawData(e){return this.parseName(e).parseComments(e).parseAuthor(e).parsePosition(e).parseRuleFromHeader(e).parseHeaderLine(e).parseCellData(e)}parsePosition(e){var r=(e.match(/^#R.*/gm)||[""])[0];return r?((r=r.match(/-?\d*/g).filter(e=>!!e))[0]&&(this.relativePos.x=parseInt(r[0])),r[1]&&(this.relativePos.y=parseInt(r[1])),this):this}parseRuleFromHeader(e){var r=(e.match(/^#r.*/gm)||[""])[0];return r&&(r=r.substr(2).trim()),this.ruleStr=r,this}parseName(e){var r=(e.match(/^#N.*/gm)||[""])[0];return r&&(r=r.substr(2).trim()),this.name=r,this}parseAuthor(e){var r=(e.match(/^#O.*/gm)||[""])[0];return r&&(r=r.substr(2).trim()),this.author=r,this}parseComments(e){var r=e.match(/^#C.*|^#c.*/gm)||[];return r=r.map(e=>e.substr(2).trim()),this.comments=r,this}parseHeaderLine(e){var r=e.toLowerCase();return(r=((r=r.match(/x\s?=\s?\d*\s?,\s?y\s?=\s?\d*.*/gm))||[""])[0])?(r.split(",").map(e=>e.trim()).forEach(e=>{var r=e.split("=")[1].trim();"x"===e.substr(0,1)?this.width=parseInt(r):"y"===e.substr(0,1)?this.height=parseInt(r):"r"===e.substr(0,1)&&(this.ruleStr=r)}),this):this}parseCellData(e){var r=[],t=[];return((e.match(/^[\dbo\$]*!?$/gm)||[]).filter(e=>!!e).join("").match(/\d*b|\d*o|\d*\$/gm)||[]).forEach(e=>{for(var i=e.substr(-1),s=parseInt((e.match(/\d*/g)||[]).filter(e=>!!e)[0]||1);s--;)"$"==i?(r.push(t),t=[]):t.push("o"==i?1:0)}),t.length&&r.push(t),this.rows=r,this}}class GoLRenderer{constructor(e){e||(e={}),this.boxSize=+e.boxSize||10,this.gridColor=e.gridColor||"#BFBFBF",this.aliveColor=e.aliveColor||"#000000",this.deadColor=e.deadColor||"#FFFFFF",this.ele=null,this.renderingArea=null,this.columns=0,this.rows=0}prepare(){return new Promise(e=>e())}render(e){return this}renderCell(e){return this}setRenderingArea(e){return this.renderingArea=e,this}}class GoLCanvasRenderer extends GoLRenderer{constructor(e,r){super(r),this.ele=e,this.ctx=e.getContext("2d"),this.columns=Math.floor(this.ele.width/this.boxSize),this.rows=Math.floor(this.ele.height/this.boxSize),this.renderingArea=new DOMRect(0,0,this.ele.width,this.ele.height),this.renderTimeout=!1,this.gridOverlay={img:new Image,bounds:this.renderingArea}}setRenderingArea(e){return this.renderingArea=e,this.generateGridOverlay(),this}prepare(){return this.generateGridOverlay()}renderGridLines(e,r=0,t=0){(e=e||this.ctx).lineWidth=1,e.strokeStyle=this.gridColor;for(var i=Math.ceil(this.renderingArea.x/this.boxSize);i*this.boxSize<=this.renderingArea.right;)e.beginPath(),e.moveTo(i*this.boxSize-r,this.renderingArea.top-t),e.lineTo(i*this.boxSize-r,this.renderingArea.bottom-t),e.stroke(),i++;for(var s=Math.ceil(this.renderingArea.y/this.boxSize);s*this.boxSize<=this.renderingArea.bottom;)e.beginPath(),e.moveTo(this.renderingArea.left-r,s*this.boxSize-t),e.lineTo(this.renderingArea.right-r,s*this.boxSize-t),e.stroke(),s++;return this}isInBounds(e){return e.row*this.boxSize>=this.renderingArea.left&&e.row*this.boxSize<=this.renderingArea.right&&e.col*this.boxSize>=this.renderingArea.top&&e.col*this.boxSize<=this.renderingArea.bottom}render(e){this.ctx.fillStyle=this.deadColor,this.ctx.fillRect(this.renderingArea.x,this.renderingArea.y,this.renderingArea.width,this.renderingArea.height);for(var r=e.length;r--;)this.isInBounds(e[r])&&this.renderCell(e[r]);return this.ctx.drawImage(this.gridOverlay.img,this.gridOverlay.bounds.x,this.gridOverlay.bounds.y),this}renderCell(e){return this.ctx.fillStyle=e.alive?this.aliveColor:this.deadColor,this.ctx.fillRect(e.col*this.boxSize+.5,e.row*this.boxSize+.5,this.boxSize-1,this.boxSize-1),this}generateGridOverlay(){return this.gridOverlay.bounds=new DOMRect(this.renderingArea.x,this.renderingArea.y,this.renderingArea.width,this.renderingArea.height),new Promise(e=>{!1!==this.renderTimeout&&clearTimeout(this.renderTimeout),this.renderTimeout=setTimeout(()=>{var r=document.createElement("canvas"),t=r.getContext("2d"),i=new Image;r.width=this.gridOverlay.bounds.width,r.height=this.gridOverlay.bounds.height,this.renderGridLines(t,this.renderingArea.x,this.renderingArea.y),i.onload=(()=>{this.gridOverlay.bounds.x===this.renderingArea.x&&this.gridOverlay.bounds.y===this.renderingArea.y&&this.gridOverlay.bounds.width===this.renderingArea.width&&this.gridOverlay.bounds.height===this.renderingArea.height&&(this.gridOverlay.img=i,this.renderTimeout=!1),e()});var s=r.toDataURL();i.src=s},1e3)})}}